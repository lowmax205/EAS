# Story 1.2: Campus-Aware Authentication & Authorization

## Status
Draft

## Story
**As a** system administrator,
**I want** user authentication to include campus context and campus-specific permissions,
**so that** users can only access data and functionality within their assigned campus scope.

## Acceptance Criteria
1. User model extended with campus assignment (defaulting to SNSU for existing users)
2. Django permission system enhanced with campus-specific role definitions
3. Authentication middleware updated to include campus context in user sessions
4. Super-admin role implemented for cross-campus management capabilities
5. Existing SNSU user permissions preserved and automatically migrated

## Integration Verification
- **IV1:** Current SNSU users can log in and access all existing functionality without changes
- **IV2:** Existing role-based permissions continue to function correctly for SNSU users
- **IV3:** Session management and security characteristics remain unchanged for existing users

## Tasks / Subtasks
- [ ] Task 1: Extend User Model with Campus Assignment (AC: 1)
  - [ ] Add campusId foreign key to User model (nullable for backward compatibility)
  - [ ] Create migration script to assign existing users to default campus (SNSU, campusId: 1)
  - [ ] Add campus validation constraints and relationship definitions
  - [ ] Update User serializers to include campus context
- [ ] Task 2: Enhance Django Permission System (AC: 2)
  - [ ] Create campus-specific permission classes (CampusAdminPermission, CampusUserPermission)
  - [ ] Implement role-based campus access controls (super_admin, campus_admin, organizer, student)
  - [ ] Define campus permission matrix with access control rules
  - [ ] Create campus permission decorators for view-level access control
- [ ] Task 3: Update Authentication Middleware (AC: 3)
  - [ ] Modify JWT token structure to include campus context (campus_id, campus_permissions)
  - [ ] Update authentication middleware to inject campus context into request
  - [ ] Implement campus session validation and access controls
  - [ ] Add campus switching rate limiting and security controls
- [ ] Task 4: Implement Super-Admin Cross-Campus Role (AC: 4)
  - [ ] Create SuperAdminPermission class with cross-campus access
  - [ ] Implement campus switching functionality for super-admins
  - [ ] Add audit logging for cross-campus operations
  - [ ] Create admin interface for campus user management
- [ ] Task 5: Preserve Existing SNSU User Permissions (AC: 5)
  - [ ] Ensure backward compatibility with existing user roles
  - [ ] Migrate existing permissions to campus-aware equivalents
  - [ ] Test existing SNSU workflows remain unchanged
  - [ ] Validate no breaking changes to current user experience

## Dev Notes

### Campus Security Architecture Context
The campus-aware authentication system implements a multi-layer security architecture with campus-based access controls. The system maintains existing SNSU functionality while adding campus isolation.

**Campus Authorization Matrix:** [Source: architecture/security-integration.md#campus-authorization-matrix]
- **super_admin:** Access to all campuses, cross-campus operations, user campus assignment
- **campus_admin:** Access to assigned campus only, within-campus user management
- **organizer:** Access to assigned campus only, event management within campus
- **student:** Access to assigned campus only, own profile and campus events

### User Model Enhancement
**Current User Model Integration:** [Source: architecture/data-model-deep-dive.md#user-model-enhancement]
```typescript
interface User {
  // Existing fields remain unchanged
  id: number;
  email: string;
  name: string;
  role: string;
  college: string; // Preserve for compatibility
  
  // New campus fields
  campusId: number; // Foreign key (1-4)
  campusName?: string; // Computed display field
}
```

### Campus JWT Token Structure
**Enhanced JWT Payload:** [Source: architecture/security-integration.md#campus-aware-jwt-token-structure]
```typescript
interface CampusJWTPayload {
  // Standard claims preserved
  sub: string; // User ID
  user_id: number;
  email: string;
  role: string;
  
  // New campus security context
  campus_id: number;
  campus_name: string;
  campus_permissions: {
    can_access_other_campuses: boolean;
    accessible_campus_ids: number[];
    is_campus_admin: boolean;
  };
}
```

### Campus Session Management
**Session Security Controls:** [Source: architecture/security-integration.md#campus-session-management]
- Campus switching rate limiting (5 switches per hour)
- Campus access validation on every request
- Audit logging for campus switching operations
- Session isolation with campus context preservation

### File Locations
- **User Model:** `backend/models/user.py` (extend existing model)
- **Permissions:** `backend/permissions/campus_permissions.py` (new file)
- **Middleware:** `backend/middleware/campus_auth.py` (new file)
- **JWT Utils:** `backend/auth/jwt_utils.py` (extend existing)
- **Migration:** `backend/migrations/add_campus_to_users.py` (new migration)

### Testing Requirements
- **Unit Tests:** Campus permission class validation, JWT token generation/validation
- **Integration Tests:** Authentication middleware with campus context, permission enforcement
- **Backward Compatibility Tests:** Existing SNSU user workflows unchanged
- **Security Tests:** Campus isolation enforcement, unauthorized cross-campus access prevention

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-07-31 | 1.0 | Initial story creation for campus-aware authentication | Bob, Scrum Master |
