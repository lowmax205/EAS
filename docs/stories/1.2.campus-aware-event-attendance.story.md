# Story 1.2: Campus-Aware Event and Attendance Management

## Status
Draft

## Story
**As an** event organizer,
**I want** events and attendance to be automatically filtered by my assigned campus,
**so that** I can only see and manage events relevant to my campus without any cross-campus data visibility.

## Acceptance Criteria
1. Event creation automatically assigns events to the organizer's campus
2. Event listing shows only events from the user's assigned campus (unless super admin)
3. Attendance tracking is campus-aware and prevents cross-campus attendance
4. QR code generation includes campus context for proper validation
5. Event CRUD operations maintain campus-based data isolation

## Integration Verification
- **IV1:** Existing SNSU event workflows remain unchanged and functional
- **IV2:** QR code scanning continues to work for existing SNSU events
- **IV3:** Event analytics and reporting maintain accuracy within campus context
- **IV4:** Performance remains acceptable for event listing and attendance operations

## Tasks / Subtasks
- [ ] Task 1: Campus-Aware Event Creation (AC: 1)
  - [ ] Modify event creation form to automatically inject campus context
  - [ ] Update EventService to assign organizer's campus to new events
  - [ ] Add campus validation to prevent manual campus override
  - [ ] Test event creation preserves existing SNSU functionality
- [ ] Task 2: Campus-Filtered Event Listing (AC: 2)
  - [ ] Implement campus filtering in event query methods
  - [ ] Update frontend event lists to show only campus-relevant events
  - [ ] Add super admin capability to view events across campuses
  - [ ] Ensure existing SNSU users see their events without disruption
- [ ] Task 3: Campus-Aware Attendance Tracking (AC: 3)
  - [ ] Modify attendance creation to include campus context validation
  - [ ] Prevent cross-campus attendance through business logic validation
  - [ ] Update attendance queries to be campus-aware
  - [ ] Maintain existing attendance workflows for SNSU users
- [ ] Task 4: Campus-Aware QR Code Generation (AC: 4)
  - [ ] Include campus identifier in QR code payload
  - [ ] Update QR validation to check campus context
  - [ ] Ensure backward compatibility with existing QR codes
  - [ ] Test QR scanning with campus validation
- [ ] Task 5: Campus-Isolated CRUD Operations (AC: 5)
  - [ ] Apply campus filtering to all event read operations
  - [ ] Restrict event updates to same campus only
  - [ ] Prevent event deletion across campus boundaries
  - [ ] Validate campus context in all event API endpoints

## Dev Notes

### Previous Story Context
**Story 1.1 Completion:** Campus data model and user assignment implemented with proper database schema and migration scripts.

### Event Management Integration
**Current Event Structure:** [Source: architecture/component-architecture.md]
```typescript
interface Event {
  id: number
  title: string
  description: string
  organizerId: number
  date: string
  location: string
  // NEW: Campus context from Story 1.1
  campusId: number
  allowedCampuses?: number[]  // For future multi-campus events
}
```

**Campus-Aware Event Service:** [Source: architecture/api-design-and-integration.md]
```typescript
class EventService {
  async createEvent(eventData: CreateEventRequest, organizerCampusId: number): Promise<Event> {
    return this.apiClient.post('/events', {
      ...eventData,
      campus_id: organizerCampusId
    })
  }
  
  async getEventsForCampus(campusId: number): Promise<Event[]> {
    return this.apiClient.get('/events', {
      params: { campus_id: campusId }
    })
  }
}
```

### QR Code Enhancement Strategy
**Campus-Aware QR Payload:** [Source: architecture/security-integration.md]
```typescript
interface QRCodePayload {
  eventId: number
  campusId: number        // NEW: Campus validation context
  timestamp: number
  signature: string       // Campus-specific signing
}
```

### Component Integration Points
**Event Creation Form:** [Source: frontend-brownfield-architecture.md]
- Location: `src/features/events/components/EventForm.tsx`
- Enhancement: Auto-inject campus context from user session
- Pattern: Use campus context provider for automatic assignment

**Event Listing Components:** [Source: frontend-brownfield-architecture.md]
- Location: `src/features/events/components/EventList.tsx`
- Enhancement: Apply campus filtering at component level
- Pattern: Use useCampusFilteredEvents hook for data fetching

### Technology Integration
**Frontend Integration:** [Source: architecture/tech-stack-alignment.md]
- **React Context:** Campus context provider for event components
- **ShadCN/UI:** Campus selector in event forms
- **State Management:** Campus-aware event state with React Query

**Backend Integration:** [Source: architecture/tech-stack-alignment.md]
- **Django Models:** Event model with campus foreign key
- **DRF Serializers:** Campus-aware event serializers
- **Permissions:** Campus-based event access control

### Testing Requirements
**Campus Event Isolation Tests:** [Source: architecture/testing-strategy.md]
```typescript
describe('Campus Event Isolation', () => {
  it('prevents organizers from seeing other campus events', () => {
    // Test cross-campus event visibility prevention
  })
  
  it('prevents attendance at other campus events', () => {
    // Test cross-campus attendance prevention
  })
})
```

### File Locations
**Frontend Files:**
- `src/features/events/services/eventService.ts` - Campus-aware API calls
- `src/features/events/components/EventForm.tsx` - Campus context injection
- `src/features/events/components/EventList.tsx` - Campus filtering
- `src/features/events/hooks/useCampusEvents.ts` - Campus event hook

**Backend Files:**
- `backend/apps/events/models.py` - Event model with campus FK
- `backend/apps/events/views.py` - Campus-aware event views
- `backend/apps/events/serializers.py` - Campus event serializers
- `backend/apps/attendance/views.py` - Campus attendance validation

### Migration Dependencies
**Prerequisite:** Story 1.1 campus data model must be completed
**Database Changes:** Event table already has campus_id from Story 1.1
**Data Migration:** Existing events assigned to organizer's campus

### Security Considerations
**Campus Validation:** [Source: architecture/security-integration.md]
- Event access validated against user's campus assignment
- QR codes include campus signature for validation
- Cross-campus operations blocked at API level

### Performance Optimization
**Query Strategy:** [Source: architecture/data-model-deep-dive.md]
- Campus-first indexing for event queries
- Composite indexes: (campus_id, date), (campus_id, organizer_id)
- Campus context cached in user session

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-07-30 | 1.0 | Event and attendance campus awareness story | Scrum Master |

## Dev Agent Record
*This section will be populated by the development agent during implementation*

## QA Results
*Results from QA Agent review will be populated here after implementation*
