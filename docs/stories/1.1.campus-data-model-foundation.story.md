# Story 1.1: Campus Data Model Foundation

## Status
Draft

## Story
**As a** system administrator,
**I want** the database schema to support multiple campuses with proper data isolation,
**so that** the system can securely manage multiple university campuses without cross-campus data leakage.

## Acceptance Criteria
1. Campus entity table created with unique identifiers, names, and configuration fields
2. All existing tables extended with campus foreign key relationships (nullable for backward compatibility)
3. SNSU data automatically assigned to default campus during migration with zero data loss
4. Database constraints enforce campus-based data isolation at the schema level
5. Migration scripts include comprehensive rollback procedures

## Integration Verification
- **IV1:** All existing SNSU events, users, and attendance records remain accessible and functional
- **IV2:** Current API endpoints continue to return correct data for existing SNSU operations
- **IV3:** Database query performance remains within acceptable thresholds for existing operations

## Tasks / Subtasks
- [ ] Task 1: Create Campus Entity Model (AC: 1)
  - [ ] Define Campus model with unique identifiers (id, name, code, domain)
  - [ ] Add campus configuration fields (timezone, locale, branding)
  - [ ] Implement Campus model validation and constraints
  - [ ] Create Campus admin interface for CRUD operations
- [ ] Task 2: Extend User Model with Campus Relationship (AC: 2)
  - [ ] Add campusId foreign key to User model (nullable for backward compatibility)
  - [ ] Create migration script to assign existing users to default campus (SNSU)
  - [ ] Update User model validation to include campus context
  - [ ] Add campus-aware user query methods
- [ ] Task 3: Extend Event Model with Campus Relationship (AC: 2)
  - [ ] Add campusId foreign key to Event model (nullable for backward compatibility)
  - [ ] Create migration script to assign existing events to organizer's campus
  - [ ] Add isMultiCampus flag for cross-campus events
  - [ ] Update Event model validation with campus constraints
- [ ] Task 4: Extend Attendance Model with Campus Context (AC: 2)
  - [ ] Add campusId foreign key to Attendance model (derived from user/event)
  - [ ] Add crossCampusAttendance boolean flag for analytics
  - [ ] Create migration script to populate campus context for existing attendance records
  - [ ] Update attendance query methods to include campus filtering
- [ ] Task 5: Database Migration and Data Preservation (AC: 3, 5)
  - [ ] Write comprehensive migration scripts with rollback procedures
  - [ ] Implement data mapping strategy for existing mock data
  - [ ] Create campus mapping based on existing college field values
  - [ ] Test migration with zero data loss validation
- [ ] Task 6: Database Constraints and Indexes (AC: 4)
  - [ ] Add foreign key constraints for campus relationships
  - [ ] Create composite indexes for campus-based queries (campus_id + date, campus_id + department_id)
  - [ ] Implement ORM-level campus filtering for data isolation
  - [ ] Add database-level constraints to prevent cross-campus data leakage

## Dev Notes

### Previous Story Insights
This is the first story in Epic 1, so no previous story context available.

### Data Models
**Campus Model Structure:** [Source: architecture/data-model-deep-dive.md#data-model-enhancement-strategy]
```typescript
interface Campus {
  id: number;           // Primary key (1-4 for existing campuses)
  name: string;         // "Main Campus", "Malimono Campus", etc.
  code: string;         // "main-campus", "malimono", etc.
  domain?: string;      // For future subdomain support
  config: {
    timezone: string;
    locale: string;
    branding?: object;
  };
}
```

**User Model Enhancement:** [Source: architecture/data-model-deep-dive.md#user-model-enhancement]
```typescript
interface User {
  // Existing fields remain unchanged
  id: number;
  email: string;
  name: string;
  role: string;
  departmentId: string;
  college: string;      // Keep for backward compatibility
  
  // New fields
  campusId: number;     // Foreign key to Campus (1-4)
  campusName?: string;  // Computed field for display
}
```

**Event Model Enhancement:** [Source: architecture/data-model-deep-dive.md#event-model-enhancement]
```typescript
interface Event {
  // Existing fields remain unchanged
  id: number;
  title: string;
  organizerId: number;
  
  // New fields
  campusId: number;           // Foreign key to Campus
  isMultiCampus: boolean;     // Allow cross-campus events (super-admin only)
  allowedCampuses?: number[]; // For multi-campus events
}
```

**Attendance Model Enhancement:** [Source: architecture/data-model-deep-dive.md#attendance-model-enhancement]
```typescript
interface Attendance {
  // Existing fields remain unchanged
  id: number;
  userId: number;
  eventId: number;
  
  // Campus context (derived from user/event)
  campusId: number;             // Auto-populated for filtering
  crossCampusAttendance: boolean; // Flag for analytics
}
```

### Campus Mapping Strategy
**Existing Campus Distribution:** [Source: architecture/data-model-deep-dive.md#campus-to-id-mapping-strategy]
```yaml
Campus Mapping:
  "main-campus" → Campus ID: 1 (Main Campus)
  "malimono" → Campus ID: 2 (Malimono Campus)
  "del-carmen" → Campus ID: 3 (Del Carmen Campus)
  "mainit" → Campus ID: 4 (Mainit Campus)
```

**Existing Data Distribution:** [Source: architecture/data-model-deep-dive.md#current-data-analysis]
- Main Campus (main-campus): 16 users (80% of total users)
- Malimono Campus (malimono): 1 user
- Del Carmen Campus (del-carmen): 1 user
- Mainit Campus (mainit): 1 user

### Database Schema Strategy
**Migration Approach:** [Source: architecture/data-model-deep-dive.md#migration-strategy-details]
1. **Phase 1: Data Mapping Migration**
   - Parse existing `college` field values
   - Map to appropriate `campusId` using campus mapping
   - Preserve original `college` field for backward compatibility
   - Add `campusId` field with proper foreign key constraints

2. **Index Strategy:** [Source: architecture/data-model-deep-dive.md#orm-level-filtering]
```sql
-- Composite indexes for performance
CREATE INDEX idx_users_campus_department ON users(campus_id, department_id);
CREATE INDEX idx_events_campus_date ON events(campus_id, date);
CREATE INDEX idx_attendance_campus_event ON attendance(campus_id, event_id);
```

### File Locations
**Django Backend Structure:** [Source: architecture/existing-project-analysis.md]
- Backend directory: `backend/`
- Requirements file: `backend/requirements.txt`
- Models location: `backend/models/` (to be created)
- Migrations location: `backend/migrations/` (to be created)
- Current state: Django backend planned, mock data services active

### Technical Constraints
**Backward Compatibility Requirements:** [Source: architecture/data-model-deep-dive.md#risk-mitigation-in-data-model]
- All existing SNSU data must remain accessible
- Current API contracts must remain unchanged
- Migration must be reversible with rollback capability
- Performance impact must be minimal (<10% overhead)

**Data Integrity Safeguards:** [Source: architecture/data-model-deep-dive.md#data-integrity-safeguards]
- Foreign key constraints on campus relationships
- Pre-migration data quality checks
- Reversible migration scripts with data preservation
- Campus isolation verification tests

### Technology Stack
**Backend Framework:** [Source: architecture/tech-stack-alignment.md]
- Django (planned) - TBD version
- Django REST Framework - TBD version
- Multi-tenant architecture pattern for campus isolation
- No new technology additions required

### Testing
**Campus Test Data Strategy:** [Source: architecture/testing-strategy.md#campus-test-data-strategy]
```typescript
interface CampusTestDataModel {
  test_campuses: {
    campus_1: {
      id: 1;
      name: "Main Campus Test";
      users: TestUser[];
      events: TestEvent[];
      departments: TestDepartment[];
    };
    campus_2: {
      id: 2;
      name: "Malimono Campus Test";
      users: TestUser[];
      events: TestEvent[];
      departments: TestDepartment[];
    };
  };
}
```

**Unit Test Requirements:** [Source: architecture/testing-strategy.md#test-categories-and-scope]
- Campus context validation functions
- Campus-aware service layer methods
- Campus filtering logic validation
- Campus authorization rule enforcement

**Integration Test Requirements:** [Source: architecture/testing-strategy.md#test-categories-and-scope]
- Database campus isolation verification
- Campus context propagation through services
- Cross-campus operation authorization

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-07-30 | 1.0 | Initial story creation with comprehensive architecture context | Scrum Master |

## Dev Agent Record
*This section will be populated by the development agent during implementation*

### Agent Model Used
*To be populated by dev agent*

### Debug Log References
*To be populated by dev agent*

### Completion Notes List
*To be populated by dev agent*

### File List
*To be populated by dev agent*

## QA Results
*Results from QA Agent review will be populated here after implementation*
